import asyncio
import aiohttp
import logging
import os
from telegram import Bot
from telegram.error import TelegramError
from tenacity import retry, stop_after_attempt, wait_exponential, retry_if_exception_type
from collections import Counter, deque

# ConfiguraÃ§Ãµes do Bot
BOT_TOKEN = os.getenv("BOT_TOKEN", "7703975421:AAG-CG5Who2xs4NlevJqB5TNvjjzeUEDz8o")
CHAT_ID = os.getenv("CHAT_ID", "-1002859771274")
API_URL = "https://api.casinoscores.com/svc-evolution-game-events/api/bacbo/latest"

# Inicializar o bot
bot = Bot(token=BOT_TOKEN)

# ConfiguraÃ§Ã£o de logging
logging.basicConfig(level=logging.DEBUG, format="%(asctime)s - %(levelname)s - %(message)s")

# HistÃ³rico e estado
historico = deque(maxlen=100)
ultimo_resultado_id = None
sinais_ativos = []
placar = {"âœ…": 0}
rodadas_desde_erro = 0
ultima_mensagem_monitoramento = None
detecao_pausada = False
sinal_em_processo = False

# Mapeamento de outcomes para emojis
OUTCOME_MAP = {
    "PlayerWon": "ğŸ”µ",
    "BankerWon": "ğŸ”´",
    "Tie": "ğŸŸ¡"
}

# PadrÃµes fixos como fallback
PADROES_FIXOS = [
    {"id": 10, "sequencia": ["ğŸ”µ", "ğŸ”´"], "sinal": "ğŸ”µ"},
    {"id": 11, "sequencia": ["ğŸ”´", "ğŸ”µ"], "sinal": "ğŸ”´"},
    {"id": 13, "sequencia": ["ğŸ”µ", "ğŸ”µ", "ğŸ”µ", "ğŸ”´", "ğŸ”´", "ğŸ”µ", "ğŸ”µ"], "sinal": "ğŸ”´"},
    {"id": 14, "sequencia": ["ğŸ”´", "ğŸ”´", "ğŸ”´", "ğŸ”µ", "ğŸ”µ", "ğŸ”´", "ğŸ”´"], "sinal": "ğŸ”µ"},
    {"id": 15, "sequencia": ["ğŸ”´", "ğŸ”´", "ğŸŸ¡"], "sinal": "ğŸ”´"},
    {"id": 16, "sequencia": ["ğŸ”µ", "ğŸ”µ", "ğŸŸ¡"], "sinal": "ğŸ”µ"},
    {"id": 17, "sequencia": ["ğŸ”´", "ğŸ”´", "ğŸ”µ", "ğŸ”µ", "ğŸ”´"], "sinal": "ğŸ”´"},
    {"id": 18, "sequencia": ["ğŸ”µ", "ğŸ”µ", "ğŸ”´", "ğŸ”´", "ğŸ”µ"], "sinal": "ğŸ”µ"},
    {"id": 19, "sequencia": ["ğŸ”´", "ğŸ”µ", "ğŸ”´", "ğŸ”´"], "sinal": "ğŸ”µ"},
    {"id": 20, "sequencia": ["ğŸ”µ", "ğŸ”´", "ğŸ”µ", "ğŸ”µ"], "sinal": "ğŸ”´"},
    {"id": 21, "sequencia": ["ğŸ”µ", "ğŸ”µ", "ğŸ”µ", "ğŸ”´", "ğŸ”µ", "ğŸ”µ"], "sinal": "ğŸ”µ"},
    {"id": 22, "sequencia": ["ğŸ”´", "ğŸ”´", "ğŸ”´", "ğŸ”µ", "ğŸ”´", "ğŸ”´"], "sinal": "ğŸ”´"},
    {"id": 23, "sequencia": ["ğŸ”µ", "ğŸ”µ", "ğŸ”´", "ğŸ”µ", "ğŸ”µ"], "sinal": "ğŸ”´"},
    {"id": 24, "sequencia": ["ğŸ”´", "ğŸ”´", "ğŸ”µ", "ğŸ”´", "ğŸ”´"], "sinal": "ğŸ”µ"},
    {"id": 25, "sequencia": ["ğŸ”µ", "ğŸ”µ", "ğŸ”µ", "ğŸ”µ"], "sinal": "ğŸ”µ"},
    {"id": 26, "sequencia": ["ğŸ”´", "ğŸ”´", "ğŸ”´", "ğŸ”´"], "sinal": "ğŸ”´"},
    {"id": 31, "sequencia": ["ğŸ”´", "ğŸ”´", "ğŸ”´"], "sinal": "ğŸ”µ"},
    {"id": 34, "sequencia": ["ğŸ”µ", "ğŸ”µ", "ğŸ”µ"], "sinal": "ğŸ”´"},
    {"id": 35, "sequencia": ["ğŸ”´", "ğŸ”´", "ğŸŸ¡"], "sinal": "ğŸ”´"},
    {"id": 36, "sequencia": ["ğŸ”µ", "ğŸ”µ", "ğŸŸ¡"], "sinal": "ğŸ”µ"},
    {"id": 39, "sequencia": ["ğŸ”´", "ğŸŸ¡", "ğŸ”´", "ğŸ”µ"], "sinal": "ğŸ”µ"},
    {"id": 40, "sequencia": ["ğŸ”µ", "ğŸŸ¡", "ğŸ”µ", "ğŸ”´"], "sinal": "ğŸ”´"},
    {"id": 41, "sequencia": ["ğŸ”´", "ğŸ”µ", "ğŸŸ¡", "ğŸ”´"], "sinal": "ğŸ”´"},
    {"id": 42, "sequencia": ["ğŸ”µ", "ğŸ”´", "ğŸŸ¡", "ğŸ”µ"], "sinal": "ğŸ”µ"},
    {"id": 43, "sequencia": ["ğŸ”´", "ğŸ”´", "ğŸ”µ", "ğŸŸ¡"], "sinal": "ğŸ”´"},
    {"id": 44, "sequencia": ["ğŸ”µ", "ğŸ”µ", "ğŸ”´", "ğŸŸ¡"], "sinal": "ğŸ”µ"},
    {"id": 45, "sequencia": ["ğŸ”µ", "ğŸŸ¡", "ğŸŸ¡"], "sinal": "ğŸ”µ"},
    {"id": 46, "sequencia": ["ğŸ”´", "ğŸŸ¡", "ğŸŸ¡"], "sinal": "ğŸ”´"},
    {"id": 1, "sequencia": ["ğŸ”µ", "ğŸ”´", "ğŸ”µ", "ğŸ”´"], "sinal": "ğŸ”µ"},
    {"id": 2, "sequencia": ["ğŸ”´", "ğŸ”´", "ğŸ”´", "ğŸ”´", "ğŸ”´"], "sinal": "ğŸ”´"},
    {"id": 3, "sequencia": ["ğŸ”µ", "ğŸ”µ", "ğŸ”µ", "ğŸ”µ", "ğŸ”µ"], "sinal": "ğŸ”µ"},
    {"id": 4, "sequencia": ["ğŸ”´", "ğŸ”´", "ğŸ”µ", "ğŸ”µ"], "sinal": "ğŸ”´"},
    {"id": 5, "sequencia": ["ğŸ”´", "ğŸ”µ", "ğŸ”´", "ğŸ”µ"], "sinal": "ğŸ”´"},
    {"id": 6, "sequencia": ["ğŸ”´", "ğŸ”´", "ğŸ”´", "ğŸ”´", "ğŸ”µ"], "sinal": "ğŸ”µ"},
    {"
